<!DOCTYPE html>
<html lang="en-GB-oxendict">
<head>
    <txp:output_form form="head" />
    <txp:if_category>
        <title>Category: <txp:category title /> / Textpattern CMS plugins</title>
        <meta name="description" content="Textpattern plugin ‘<txp:category title />’ category.">
        <meta name="robots" content="noindex, follow">
    <txp:else />
        <title>Textpattern CMS plugins | Plugins for the Textpattern content management system</title>
        <meta name="description" content="A curated collection of plugins, extensions, modifications and add-ons for Textpattern CMS.">
        <meta name="keywords" content="plugins, extensions, add-ons, modifications, cms, content management systems, open source, blogs, blogging, free, web design, web site design, web development, web site development, php, foss">
        <meta name="robots" content="index, follow">
        <link rel="canonical" href="<txp:site_url />">
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@textpattern">
        <meta name="twitter:title" content="Textpattern CMS plugins | Plugins for the Textpattern content management system">
        <meta name="twitter:description" content="A curated collection of plugins, extensions, modifications and add-ons for Textpattern CMS.">
        <meta name="twitter:image:src" content="https://textpattern.com/apple-touch-icon-180x180.png">
        <meta name="twitter:url" content="<txp:site_url />">
        <meta property="og:site_name" content="Textpattern CMS">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Textpattern CMS plugins | Plugins for the Textpattern content management system">
        <meta property="og:description" content="A curated collection of plugins, extensions, modifications and add-ons for Textpattern CMS.">
        <meta property="og:image" content="https://textpattern.com/assets/img/branding/textpattern/textpattern-og.png">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="1200">
        <meta property="og:image:alt" content="Textpattern logo">
        <meta property="og:url" content="<txp:site_url />">
        <script type="application/ld+json">
            {
                "@context": "https://schema.org",
                "@type": "WebSite",
                "headline": "Textpattern CMS plugins | Plugins for the Textpattern content management system",
                "description": "A curated collection of plugins, extensions, modifications and add-ons for Textpattern CMS.",
                "url": "<txp:site_url escape="json" />"
            }
        </script>
    </txp:if_category>
</head>
<body itemscope itemtype="https://schema.org/WebPage">
    <txp:output_form form="body_header" />
    <main aria-label="Main content">
        <div class="container">
            <div class="layout-container">
                <txp:output_form form="body_crumbs" />
                <article class="layout-4col-3span" itemscope itemtype="https://schema.org/Article">

<txp:php>
function formatBytes($bytes, $precision = 2) {
    $units = array('B', 'KB', 'MB', 'GB', 'TB');

    $bytes = max($bytes, 0);
    $pow = floor(($bytes ? log($bytes) : 0) / log(1024));
    $pow = min($pow, count($units) - 1);

    $bytes /= pow(1024, $pow);

    return round($bytes, $precision).$units[$pow];
}

$github_key = parse('<txp:variable name="github-api-key" />');
$github_url = parse('<txp:custom_field name="github-repo" />');
$github_ident = explode('/', parse_url($github_url, PHP_URL_PATH));

$query = <<<'GRAPHQL'
query($organizationLogin:String!,$repositoryName:String!) {
  repository(owner:$organizationLogin, name:$repositoryName) {
    name
    url
    homepageUrl
    description
    stargazers {
      totalCount
    }
    releases(first: 10, orderBy: {field:CREATED_AT, direction:DESC}) {
      totalCount
      nodes {
        releaseAssets(last: 5) {
          nodes {
            createdAt
            name
            downloadCount
            createdAt
            downloadUrl
            size
            release {
              tagName
              name
              isPrerelease
              url
            }
          }
        }
      }
    }
    repositoryTopics(last: 10) {
      edges {
        node {
          url
          topic {
            name
          }
        }
      }
    }
    licenseInfo {
        name
        url
    }
    pushedAt
  }
}
GRAPHQL;
$variables = [
    'organizationLogin' => $github_ident[1],
    'repositoryName' => $github_ident[2]
];

$json = json_encode(['query' => $query, 'variables' => $variables]);
$curl = curl_init();

curl_setopt($curl, CURLOPT_URL, 'https://api.github.com/graphql');
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($curl, CURLOPT_POSTFIELDS, $json);
curl_setopt($curl, CURLOPT_HTTPHEADER,
     array(
            'User-Agent: Textpattern CMS',
            'Content-Type: application/json;charset=utf-8',
            'Authorization: bearer '.$github_key
        )
    );

$response = curl_exec($curl);

if (curl_error($curl)) {
    // Do nothing.
} else {
    $data = json_decode($response);

    echo '<h1>Plugin: '.htmlspecialchars($data->data->repository->name).'</h1>';
    echo '<p><a class="button" rel="external" href="'.$data->data->repository->url.'" title="Stars on GitHub"><span class="ui-icon ui-extra-icon-github">GitHub</span> <strong>Stars</strong></a> <a class="count-bubble" rel="external" href="'.$data->data->repository->url.'/stargazers" title="Stargazers on GitHub">'.intval($data->data->repository->stargazers->totalCount).'</a>';
    echo '<p>License: <a href="'.$data->data->repository->licenseInfo->url.'">'.htmlspecialchars($data->data->repository->licenseInfo->name).'</a></p>';
    echo '<p>Latest activity: '.$data->data->repository->pushedAt.'</p>';
    echo '<h3 id="releases">Download releases</h3>';
    echo '<p>Total number of releases: '.$data->data->repository->releases->totalCount.' <a rel="external" href="'.$data->data->repository->url.'/releases"><span class="ui-icon ui-icon-extlink" title="View all releases on GitHub">View all releases on GitHub</span></a></p>';
    echo '<dl>';

    foreach ($data->data->repository->releases->nodes as $releaseElement) {
        echo '<dt>'.htmlspecialchars($releaseElement->releaseAssets->nodes[0]->release->name).
            ' <a rel="external" href="'.$releaseElement->releaseAssets->nodes[0]->release->url.'"><span class="ui-icon ui-icon-extlink" title="View this release on GitHub">View this release on GitHub</span></a>'.
            ' <small class="alert-block alert-pill warning">Prerelease</small></dt>';

        foreach ($releaseElement->releaseAssets->nodes as $releaseSubElement) {
            echo '<dd><a href="'.$releaseSubElement->downloadUrl.'" title="Download this file"><span class="ui-icon ui-extra-icon-download"></span> '.htmlspecialchars($releaseSubElement->name).'</a> <small>('.formatBytes($releaseSubElement->size).')</small></dd>';
        }
    }

    echo '</dl>';
}

curl_close($curl);

</txp:php>

                </article>
                <section class="layout-4col sidebar">
                    <h3>Latest activity</h3>
                    <p>TODO</p>
                    <h3>Contributors</h3>
                    <p>TODO</p>
                    <h3>License</h3>
                    <p>TODO</p>
                </section>
            </div>
        </div>
    </main>
    <txp:output_form form="body_footer" />
</body>
</html>
